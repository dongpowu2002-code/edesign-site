<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eDesign Labs | ‰ªªÂä°ÁÆ°ÁêÜ‰∏≠ÂøÉ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-[#0f172a] text-slate-100 min-h-screen flex flex-col items-center py-6 px-4">

    <div class="max-w-md w-full space-y-5">
        <div class="flex justify-between items-center px-4 py-2 bg-slate-800 rounded-2xl border border-slate-700 shadow-lg">
            <div class="flex items-center gap-2">
                <div id="sync-icon" class="w-2 h-2 rounded-full bg-slate-500 transition-colors duration-500"></div>
                <span id="sync-text" class="text-[10px] font-mono text-slate-400 uppercase">ÂàùÂßãÂåñ‰∏≠...</span>
            </div>
            <button onclick="fetchData()" class="text-[9px] font-bold text-sky-400 hover:text-sky-300">Âº∫Âà∂Âà∑Êñ∞Êï∞ÊçÆ</button>
        </div>
        
        <div class="grid grid-cols-2 gap-3">
            <button id="btn-WDP" onclick="setUser('WDP')" class="bg-slate-800 border-2 border-slate-700 py-3 rounded-xl font-bold hover:border-sky-500 transition-all text-sm tracking-widest">WDP</button>
            <button id="btn-YAJ" onclick="setUser('YAJ')" class="bg-slate-800 border-2 border-slate-700 py-3 rounded-xl font-bold hover:border-sky-500 transition-all text-sm tracking-widest">YAJ</button>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700 text-center shadow-2xl">
                <div class="text-5xl font-black text-red-500" id="star-count">0</div>
                <div class="text-[10px] text-slate-500 font-bold uppercase mt-2 tracking-widest">Stars ‚≠ê</div>
            </div>
            <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700 text-center shadow-2xl">
                <div class="text-5xl font-black text-orange-500" id="bomb-count">0</div>
                <div class="text-[10px] text-slate-500 font-bold uppercase mt-2 tracking-widest">Bombs üí£</div>
            </div>
        </div>

        <div class="bg-slate-800 p-6 rounded-[2rem] border border-slate-700 shadow-2xl opacity-40 pointer-events-none transition-all duration-300" id="control-panel">
            <div class="space-y-4">
                <div class="flex gap-2">
                    <input type="number" id="input-qty" value="1" min="1" class="w-20 bg-slate-900 border border-slate-700 rounded-xl py-3 text-center text-sky-400 font-bold outline-none focus:border-sky-500">
                    <input type="text" id="input-remark" placeholder="Ê∑ªÂä†Â§áÊ≥®ÁêÜÁî±..." class="flex-1 bg-slate-900 border border-slate-700 rounded-xl py-3 px-4 text-sm outline-none focus:border-sky-500">
                </div>
                <div class="flex gap-2">
                    <button onclick="change('star', -1)" class="w-14 bg-slate-700 text-red-500 py-4 rounded-xl font-black border border-red-900/20 active:bg-red-900/40">-</button>
                    <button onclick="change('star', 1)" class="flex-1 bg-red-600 hover:bg-red-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-red-900/40">Â¢ûÂä†Á∫¢Êòü ‚≠ê</button>
                </div>
                <div class="flex gap-2">
                    <button onclick="change('bomb', -1)" class="w-14 bg-slate-700 text-orange-500 py-4 rounded-xl font-black border border-orange-900/20 active:bg-orange-900/40">-</button>
                    <button onclick="change('bomb', 1)" class="flex-1 bg-orange-600 hover:bg-orange-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-orange-900/40">Â¢ûÂä†ÁÇ∏Âºπ üí£</button>
                </div>
            </div>
        </div>

        <div class="bg-slate-800/40 rounded-2xl p-4 h-48 border border-slate-700 flex flex-col">
            <div id="log-container" class="overflow-y-auto space-y-2 flex-1 text-[11px] font-mono text-slate-500"></div>
        </div>
    </div>

    <script>
        // --- ‰Ω†ÁöÑ‰∏ìÂ±ûÈÖçÁΩÆ ---
        const SUPABASE_URL = 'https://fxryglifcrfdtreozogr.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_lNQnRSRnekuxuWCwi3WE_A_YQSgdm-q';
        
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let counts = { star: 0, bomb: 0 };
        let logs = [];
        let currentUser = null;

        window.onload = fetchData;

        async function fetchData() {
            setSyncStatus('ÂêåÊ≠•‰∏≠...', 'blue');
            try {
                const { data, error } = await _supabase.from('task_records').select('*').eq('id', 1).single();
                if (data) {
                    counts = data.counts;
                    logs = data.logs;
                    updateUI();
                    renderLogs();
                    setSyncStatus('‰∫ëÁ´ØÂêåÊ≠•ÊàêÂäü', 'green');
                } else if (error) {
                    console.error(error);
                    setSyncStatus('Ëé∑ÂèñÂ§±Ë¥• (Ê£ÄÊü•SQLË°®)', 'red');
                }
            } catch (e) {
                setSyncStatus('ÁΩëÁªúÂºÇÂ∏∏', 'red');
            }
        }

        async function updateCloud(newLog) {
            setSyncStatus('‰øùÂ≠ò‰∏≠...', 'blue');
            logs.unshift(newLog);
            if (logs.length > 25) logs.pop();

            const { error } = await _supabase.from('task_records').update({ counts, logs }).eq('id', 1);
            
            if (error) {
                console.error(error);
                setSyncStatus('‰øùÂ≠òÂ§±Ë¥•', 'red');
            } else {
                setSyncStatus('‰∫ëÁ´ØÂ∑≤ÂêåÊ≠•', 'green');
            }
            renderLogs();
        }

        function setUser(name) {
            currentUser = name;
            document.getElementById('control-panel').classList.remove('opacity-40', 'pointer-events-none');
            document.querySelectorAll('[id^="btn-"]').forEach(el => el.classList.remove('border-sky-500'));
            document.getElementById(`btn-${name}`).classList.add('border-sky-500');
        }

        async function change(type, dir) {
            if (!currentUser) return;
            const qty = Math.max(1, parseInt(document.getElementById('input-qty').value) || 1);
            const remark = document.getElementById('input-remark').value || '-';
            const delta = qty * dir;

            if (counts[type] + delta < 0) return alert("Êï∞Èáè‰∏çË∂≥ÔºÅ");
            
            counts[type] += delta;
            updateUI();
            
            const time = new Date().toLocaleTimeString();
            const logHTML = `<div class="border-b border-slate-800 pb-1">
                <span class="${dir > 0 ? 'text-sky-400' : 'text-slate-400'}">${dir > 0 ? 'Ôºã' : 'Ôºç'} ${type==='star'?'‚≠ê':'üí£'} ${qty}</span>
                <span class="ml-2">[${time}] ${currentUser}: "${remark}"</span>
            </div>`;
            
            await updateCloud(logHTML);
            document.getElementById('input-remark').value = '';
            document.getElementById('input-qty').value = '1';
        }

        function updateUI() {
            document.getElementById('star-count').innerText = counts.star;
            document.getElementById('bomb-count').innerText = counts.bomb;
        }

        function renderLogs() {
            document.getElementById('log-container').innerHTML = logs.join('');
        }

        function setSyncStatus(msg, color) {
            document.getElementById('sync-text').innerText = msg;
            const colors = { green: 'bg-green-500', blue: 'bg-sky-500', red: 'bg-red-500', orange: 'bg-orange-500' };
            document.getElementById('sync-icon').className = `w-2 h-2 rounded-full ${colors[color]}`;
        }
    </script>
</body>
</html>
